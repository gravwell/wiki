# 高度なGravwell設定

このドキュメントでは、ストレージウェル、データエイジアウト、マルチノードクラスタの設定に関する情報を含む、Gravwell インストールの一段と高度な設定オプションについて説明します。

Gravwellはオプションとして分散システムにすることができ、Gravwellクラスタを構成する複数のインデクサーを可能にします。デフォルトのインストールでは、ウェブサーバーとインデクサーの両方を同じマシンにインストールしますが、適切なライセンス許諾を得さえすれば、クラスタでの運用はインスタンスを一つ動かすのと同じくらい簡単です。

## インストーラーのオプション

Gravwell インストーラーは、自動インストールやデプロイを容易にするために、いくつかのフラグをサポートしています。以下のフラグがサポートされています:

| フラグ | 内容 |
|------|-------------|
| `--help` | インストーラーのヘルプメニューを表示する |
| `--no-certs` | インストーラーによって自己署名証明書は生成されない
| `--no-questions` | すべての設定はデフォルトとし、EULAを自動的に受け入れる
| `--no-random-passwords` | ランダムインジェスト用と制御用のランダムな鍵は生成されない
| `--no-indexer` | Gravwell インデクサーコンポーネントはインストールされない
| `--no-webserver` | Gravwell ウェブサーバーコンポーネントはインストールされない
| `--no-searchagent` | Gravwell検索エージェントはインストールされない(このオプションは通例上の `--no-webserver` オプションと一緒に使われる)
| `--no-start` | インストール後にコンポーネントを起動しない
| `--no-crash-report` | 自動デバッグレポートコンポーネントがインストールされない
| `--use-config` | 特定の設定ファイルを使用する

### 高度なインストールが必要となる、典型的なユースケース

複数のインデクサーを持つクラスタにGravwellをデプロイする場合には、インデクサーのノードにWebサーバーコンポーネントをインストールしたくはないはずです。

自動インストールツールを使用しているのに、インストーラーが途中で設定の選択入力を求めてそこで停止してしまうのは嬉しくないでしょう。

インデクサーとそのインジェスト用および制御用の共有鍵のリストがある場合には、インストール時に設定ファイルを指定することで、プロセスを大幅に高速化することができます。

ウェブサーバーのインストールをせず、パスワードのランダム生成を行わずにインデクサーコンポーネントをインストールする場合には、例えば次のように実行すれば良いです:

```
root@gravserver# bash gravwell_installer.sh --no-questions --no-random-passwords --no-webserver
```

もしもパスワードをランダム生成することにした場合は、インストールされたインデクサーとウェブサーバーに戻って `gravwell.conf` ファイルの `Control-Auth` パラメーターがウェブサーバーと各インデクサーで一致していることを確認する必要があります。すべてのインデクサーに同じ `Ingest-Auth` 値を設定した方が好ましいでしょう。

## 全体の設定

Gravwellクラスタの設定は、最初からシンプルで効率的なものになるように設計されています。しかし、システムが非常に大規模なシステムや、メモリ制約のある小型の組み込みデバイスや産業用デバイスでよりよく利用できるようにするには、調整ツマミがあります。コア設定ファイルはウェブサーバーとインデクサーの両方で共有されるように設計されており、デフォルトでは `/opt/gravwell/etc/gravwell.conf` にあります。

設定オプションの詳細なリストについては、[パラメーター](parameters.md)のページを参照してください。

インデクサーの設定全容については [インデクサーのデフォルト設定](indexer-default-config.md) を参照してください。

設定ファイルの中で最も重要な項目は `Ingest-Auth`, `Control-Auth`, `Search-Agent-Auth` の設定パラメーターです。`Control-Auth` パラメーターはウェブサーバーとインデクサーがお互いを認証するために使用する共有秘密です。もしも攻撃者がインデクサーと通信して `Control-Auth` トークンを持ちだせば、攻撃者はインデクサーが保存しているデータに完全にアクセスできるようになります。`Ingest-Auth` トークンはインジェスターを検証するために使用され、タグを作成してGravwellにデータをプッシュする権限を厳格に管理します。つまり、`Ingest-Auth` トークンにアクセスできた攻撃者は、非常に短い時間で膨大な量のデータをGravwellにプッシュすることができるようになってしまいます。`Search-Agent-Auth` トークンは、GravwellのSearch Agentユーティリティーが自動的にウェブサーバーに接続し、ユーザーに代わって検索実行を指令できるようににします。従って、これらのトークンは重要であり、慎重に保護する必要があります。

注意: クラスタへのGravwellインストールでは、適切な相互通信を可能にするために、すべてのノードが同じ `Ingest-Auth` と `Control-Auth` 値で構成されていることが重要です。

## ウェブサーバーの設定

ウェブサーバーはすべての検索の集約場所となり、Gravwellにインタラクティブなインターフェイスを提供します。ウェブサーバーは大規模なストレージを必要としませんが、検索で大量のデータが返ってきた場合でも、ユーザーが結果を流動的にナビゲートできるようには、非常に高速なストレージの小さな保存領域を活用すると効果的です。ウェブサーバーは検索パイプラインについても役割を持っていて、フィルタリング、メタデータ抽出、データのレンダリングの一部の処理を実行します。ウェブサーバーのハードウェア仕様を選定する際には、そこそこのサイズのソリッドステートディスク(可能であればNVME)、16GB以上のRAMのメモリプール、および少なくとも4つの物理コアを推奨します。Gravwellは並列処理能力がとても高くなるよう構築されているので、CPUコア数とメモリを追加するだけでそのパフォーマンスを向上します。32GB以上のメモリを搭載したIntel E5またはAMD Epycチップなどが良い選択です。

2つの設定オプションによってウェブサーバーがインデクサーとどのように通信するかを指定できます。`Remote-Indexers` オプションはインデクサーのIPもしくはホスト名を指定し、`Control-Auth` オプションはウェブサーバーがインデクサーの認証に使う共有鍵を与えます。例えば、3つのインデクサーに接続しているウェブサーバーは `gravwell.conf` に以下のような記述をすることになります:

```
Control-Auth=MySuperSecureControlToken
Remote-Indexers=net:10.0.1.1:9404
Remote-Indexers=net:10.0.1.2:9404
Remote-Indexers=net:10.0.1.3:9404
```

注釈: 上記の例では、インデクサーはデフォルトのポート9404で制御接続をリッスンしています。このポートはインデクサーの gravwell.conf ファイルの `Control-Port` オプションによって設定可能です。

### ウェブサーバーのTLS

デフォルトでは、Gravwell は TLS証明書を生成しません。適切に署名されたTLS証明書または自己署名証明書をウェブサーバーに設定する方法については、[TLS/HTTP 解説](certificates.md)を参照してください。

### ウェブサーバー設定で失敗しやすい場所

* Remote-Indexersが存在しない、あるいは設定ミス
* Control-Auth トークンが存在しない、あるいはウェブサーバーとインデクサーで不一致
* ウェブサーバーとバックエンドのライセンスの不一致
  * ウェブサーバーとインデクサーの両方が互換性のあるライセンスを持っている必要があります
* ウェブサーバーとインデクサー間のネットワーク接続性が悪い
  * 遅延が大きい、帯域幅が小さい、あるおはMTUサイズの設定ミスなど
* ファイアウォールがインデクサーまたはウェブサーバーのポートへのアクセスをブロックしている
  * デフォルトのポート番号は9404です。

## インデクサーの設定

インデクサーはGravwellのストレージセンターであり、データの保存、検索、処理を担当します。インデクサーは、クエリを実行する際に、最初にデータを見つけてから検索パイプラインにプッシュするという、最初の大仕事を行います。検索パイプラインは、効率化のためにインデクサー上で可能な限り多くの作業を並行して実行します。インデクサーの処理は、高速で低遅延のストレージと可能な限り多くのRAMを搭載すると効率的になります。Gravwellはファイルシステムのキャッシュを利用することができるので、同じデータに対して複数のクエリが実行された時には、ディスクにアクセスしに行く必要がありません。私たちは、十分にキャッシュされたデータ上で、Gravwellがノードあたり5GB/秒以上で動作しているのを見てきました。メモリが多ければ多いほど、より多くのデータをキャッシュすることができます。最大のマシンのメモリ容量を超える大規模な蓄積データを検索する場合には、高速RAIDアレイを用いるのがスループット向上に繋がります。

インデクサーのハードウェアには、少なくとも32GBのメモリと8個のCPUコアの搭載が推奨されます。可能であれば、Gravwellは、数日分の最新データを保持してホットウェルとして機能できるよう非常に高速なNVMEソリッドステートディスクを用い、それから回転の遅いディスクプールにエイジングすることが推奨されます。ホットウェルで最新データへの高速アクセスを可能にし、一方古いデータは整理してまとめていくことによって、Gravwellは可能な限り効率的に検索できるようになります。

インデクサーの gravwell.conf には、全体的な動作に影響を与えるいくつかの重要な設定オプションがあります:

* `Control-Port` は、インデクサーがウェブサーバーからの接続をリッスンするポートを設定します。デフォルトは9404です。
* `Control-Auth` は、ウェブサーバーが認証に使用する共有鍵を設定します。デフォルトはランダムに生成された文字列です。
* `Ingest-Port` と `TLS-Ingest-Port` はそれぞれ、暗号化されていないインジェストトラフィックと暗号化されたインジェストトラフィックをリッスンするポートを指定します。
* `Ingest-Auth` は、データインジェスターがインデクサーを認証するために使用する共有鍵を設定します。デフォルトはランダムに生成された文字列です。

インデクサーはそのデータを _well_（ウェル）に格納します。各ウェルにはいくつかのタグが格納されています。あるウェルに「pcap」とタグ付けされた100GBのデータと「syslog」とタグ付けされた10MBのデータが含まれている場合、syslogデータを検索すると、インデクサーはディスクからpcapデータも読まなければならず、検索の速度が遅くなります。この理由から、多くのデータを含むことが予想されるタグのために別のウェルを作成することを強くお勧めします。詳細については、下の「タグとウェル」のセクションを参照してください。

## タグとウェル

**タグ**は、異なるタイプのデータを論理的に分離する方法として使用されます。タグ付けはインジェスター（SimpleRelay、NetworkCaptureなど）によってインジェストされる時に適用されます。例えば、syslogログ、Apacheログ、ネットワークパケット、ビデオストリーム、オーディオストリームなどにそれぞれ別のタグを適用すると便利です。**ウェル**は、実際にインジェストされたデータを整理して保存するストレージグループです。ユーザーは通常、ウェルと対話することはありませんが、ウェルはディスク上のデータを **細かく分けて** 保存します。各断片には約1.5日分のデータが含まれています。

タグ毎にウェルを割り当てることで、データストリームをより高速ストレージプールや、あるいはより大きなストレージプールに導くことができます。例えば、高帯域幅リンクからの生の pcap ストリームは、より高速なストレージプールに割り当てる必要があるかもしれませんが、syslog やウェブサーバーからの比較的少量のログエントリは高速ストレージを必要としません。1つのウェルに複数のタグを含めることはできますが、1つのタグを複数のウェルに割り当てることはできません。データストリームを論理的、物理的に分離することで、異なるデータに異なるルールを適用することができます。例えば、ネットワークトラフィックのような高帯域幅のストリームは15日ごとに期限切れや圧縮を行い、低帯域幅のストリームはずっと長い期間維持することが望ましい場合があります。論理的な分離はまた、システムがタグに基づいて適切なウェルをインテリジェントにクエリーするため、検索パフォーマンスを大幅に向上させます(例えば、デフォルトという名前のウェルにあるsyslogエントリを検索する場合、Gravwellは他のウェルには関与しません)。

タグとウェルのマッピングは、`/opt/gravwell/etc/gravwell.conf`設定ファイルで定義されています。デフォルトでは、すべてのタグを受け入れる `Default-Well` のみが設定されます。複数のウェルに関連するタグを持つインデクサーの設定の抄録例は以下のようになります:

```
[Default-Well]
	Location=/opt/gravwell/storage/default/

[storage-well "raw"]
	Location=/opt/gravwell/storage/raw/
	tags=pcap
	tags=video
```

このように、"raw"（生データ）と命名されたウェルは、"pcap"や"video"とタグ付けされたのデータを保存するために使用されているので、きっとかなりの量のストレージを消費するはずだと推察することができます。

### タグの制限と潜在的な問題

タグ名には英数字のみを使うことができます。つまり、ダッシュ、アンダースコア、特殊文字などはタグ名には使用できません。タグ名は、"syslog" や "apache" のように、入力が簡単で、データがどのように用いられているかという種類を反映したシンプルな名前にすべきでしょう。

デフォルトウェルは、他のウェルに明示的に割り当てられていないタグを持つすべてのエントリを受け取ります。例えば、Syslogという名前のウェルがあって、そのウェルには"syslog"と "apache"というタグが割り当てられているのなら、それら2種類以外のタグが付されたエントリは全てデフォルトウェルに送られます。そのことから、インジェスターで、gravwell.confファイルで明示的に定義されていないタグ名を持つエントリを生成しても問題ありません。そのようなエントリは、単に、他の未割り当てのタグと一緒に混ざってデフォルトウェルに入っていることになるだけです。

特定のタグの割り当て先ウェルを別のウェルに替えて割り当てても、システムはデータを移動しません。"syslog"タグをデフォルト以外の特定のウェルに設定することなしに"syslog"タグ付データをインジェストした後、設定ファイルを変更して新しいウェルを定義したり、既存のウェルに"syslog"タグを割り当てたりした場合、デフォルトのウェルに存在する"syslog"タグ付きのデータはその後検索できなくなります。取り出せなくなったエントリを回復することができるウェルとタグの移行のためのスタンドアロンツールへのアクセスや、古いウェルの内容を新しく合理化された/代替されたウェル構成に再インジェストするためのヘルプについては、support@gravwell.io までお問い合わせください。

## データのエイジアウト

Gravwellは、データ管理ポリシーを個々のウェルに適用できるエイジアウトシステムをサポートしています。エイジアウトポリシーは、データの保持、ストレージウェルの使用率、および圧縮を制御します。データのエイジアウトの設定の詳細については、[エイジアウト](ageout.md)を参照してください。

## ウェルのレプリケーション

複数のインデクサーノードを持つGravwellクラスタでは、ディスク障害や誤って削除された場合でも、ノード間でデータ複製（レプリケーション）するように設定することができます。レプリケーションの設定については、[レプリケーション](replication.md)を参照してください。

## クエリのアクセラレーション

Gravwellは、ウェル毎に"アクセラレータ"というオプション設定することをサポートしており、インジェスト時にデータにパーサを適用して最適化ブロックを生成することができます。アクセラレータは、クエリモジュールと同じように柔軟性があり、クエリを実行する際に透過的に使用されます。アクセラレータは、特定のフィールド値を持つデータを非常に迅速にゼロにする必要がある、藁の山から針を探すようなタイプのようなスタイルのクエリに非常に便利です。詳細な情報と設定方法については、[アクセラレータ](accelerators.md)セクションを参照してください。

## 複雑なパスワード

Gravwellは、シングルサインオンモードでない場合に、ユーザーに設定パスワードを複雑にすることを強制するオプションをサポートしています。パスワードをどのように複雑にさせるかという設定を有効にするには、`gravwell.conf`ファイルに以下の記述を追加してください:

```
[Password-Controls]
	Min-Length=<integer>
	Require-Uppercase=<bool>
	Require-Lowercase=<bool>
	Require-Number=<bool>
	Require-Special=<bool>
```

デフォルトのGravwellデプロイでは、複雑なパスワードのルールは強制されていません。というのも、Gravwellは安全なbcryptパスワードハッシュシステムを使用しているので、事実上、これらのルールを強制する意味がありません。複雑なパスワード要件を有効にすると、その後のすべてのパスワード変更はこの要件に従う必要があります。

ここでは、10 文字以上の複雑なパスワードを必要とする設定ブロックの例を示します:

```
[Password-Controls]
	Min-Length=10
	Require-Uppercase=true
	Require-Lowercase=true
	Require-Number=true
	Require-Special=true

```

GravwellはUTF-8の文字セットを完全にサポートしていますが、多くの言語では大文字小文字の概念がないことに注意してください。そのため、`パスワードを推測することはできません!#$@42`というパスワードは非常に複雑に見えるかもしれませんが、大文字と小文字の値がないため、上記の要件を満たしていません。

## バージョンの互換性 

インデクサーやウェブサーバーはバージョン毎に、限られたバージョンのインデクサーやウェブサーバーとしか互換性を持ちません。以下の表は、バージョン互換性の制限についての詳細です。互換性のないウェブサーバーやインデクサーは動作しません。

| APIバージョン | 互換性のあるインデクサー/ウェブサーバーのバージョン |
|-------------|---------------|
| 1 | 1.0から3.3までの全バージョン |
| 2 | 4.0 と 4.1 |
| 3 | 4.2 |

インジェスターは、接続時にインジェストプロトコルのバージョンをネゴシエートするため、古いバージョンのインデクサーと常に後方互換性があります。ただし、バージョンが大きくかけ離れてる場合、一部の新機能が無効になることがあります。お使いのインデクサのバージョンに合ったインジェスターのバージョンを使用することをお勧めします。
