# データエイジアウト

Gravwellは、データ管理ポリシーを個々のウェルに適用できるエイジアウトシステムをサポートしています。エイジアウトポリシーは、データの保持、ストレージウェルの利用、および圧縮を制御する。各ウェルは、データが1つのストレージシステムから他のストレージシステムにどのように移動されるかを決定する一連のパラメータを持つホットおよびコールドストレージの場所をサポートしています。理想的なGravwellストレージアーキテクチャは、ランダムアクセスに耐性のある高速ストレージの比較的小さなプールと、長期的なストレージに使用される大容量/低コストのストレージプールで構成されています。NVMEベースのフラッシュおよび/またはXPointドライブは、ホットウェルに最適ですが、磁気RAIDアレイ、NAS、またはSANプールはコールドプールに適しています。エイジアウト中に検索が妨げられることはありませんし、摂取することもありません。
Gravwellは、デフォルト設定ではデータを削除しないようになっています。従って、ユーザーが、各ストレージウェルについてデータの移行や削除に関するポリシーを指定する必要があります。データの保持、ストレージウェルの利用、圧縮の制御方法を指定するのが「エイジアウト」ポリシーです。 各ウェルには、ホットロケーションとコールドストレージロケーション（オプション）が用意されており、データをストレージシステム間で移動させる方法を決定するパラメータが設定されています。理想的なGravwellストレージアーキテクチャは、比較的小規模な高速ストレージプールを「ホット」ストレージとして使用し、大容量かつ低コストのストレージプールを長期的な「コールド」ストレージとして使用することで構成されます。 NVMEベースのフラッシュやXPointドライブは、ホットウェルに最適であり、磁気RAIDアレイ、NAS、SANプールはコールドプールに適している。

ウェル内のストレージの単位は**shard**で、約1.5日(2<sup>17</sup>秒)間分のデータ量に相当します。**active shard**は、現時点のエントリを受信しているシャードです。2<sup>17</sup>秒ごとに、新しいアクティブ・シャードが作成され、その時点までアクティブだったシャードはエイジアウトの対象となります。エイジアウトは常に１単位のシャード全体に作用します。このため、最も厳格なエイジアウトポリシーを採用していても、各ウェルには約1.5日分のデータを保存するのに十分な容量が必要となりますので、計画を立てる際にはこの点に注意してください。ストレージの上限を1GBに設定していても、1時間後に1つのシャードに10GBのデータを取り込んだ場合、アクティブなシャードがエイジアウトされるまで、ウェルは10GBを占有することになります。エイジアウトの間も、インジェストの間も、検索は妨げられません。

エイジアウトポリシーは、3つのパラメータで定義できます：

* 時間
* 合計ストレージ
* ストレージの可用性

時間ベースのパラメータによって、ポリシー、契約上の合意、または法的要件に準拠するためにデータ保持ポリシーを指定することができます。例えば、企業のポリシーでは、Webプロキシのログは30日以内に保存することになっているかもしれません。

 合計ストレージパラメータは、ウェルのストレージ上限を指定し、保存されたデータ量がストレージ上限を超えた場合にのみ、データをエージアウトするか廃棄するようにGravwellに指示します。

ストレージ利用量パラメータは、利用可能なストレージの最低量を維持するように Gravwell に指示し、そのためのスペースを空けるために必要に応じてデータをエージングするようにします。ストレージ利用量の確保は、Gravwellがデバイス上で空きストレージを使用できるようにしている時に、デバイスの空き容量が利用量のしきい値を下回った場合にデータを破棄しようとする場合に便利です。

1つのウェルに複数の制約を追加することができます。例えば、合計が100GBを超えない限り、データを最大90日間保存するように指定することができます。

エイジアウトシステムは、エントリをホットプールからコールドプールに転送する際に、データストレージを最適化するように設計されています。最適化により、同じ時間範囲とタグのエントリがローカライズされ、従来の回転ディスク上でのヘッドの動きが軽減されます。圧縮と組み合わせることで、最適化フェーズでは、コールドデータのストレージ利用率と検索パフォーマンスを大幅に向上させることができます。

エイジアウトシステムは古いデータを削除するように構成できるため、十分なエイジアウトを行う前に構成を精査することが非常に重要です。

## 基本構成

各ウェルは常に `Location` ディレクティブで定義されたホットストレージの位置を持ちます。オプションで `Cold-Location` で定義されたコールドストレージの場所を持つこともできます。エイジアウトは、ホットストレージからコールドストレージへのデータの移動や削除、コールドストレージからアーカイブや削除へのデータの移動や削除のための制約を設定し、必要なルールを定義することで設定されます。削除ルールが*明示的に*提供されていない限り、Gravwellはデータを*削除しないことに注意してください。

重要：エイジアウトの設定は、ウェルごとに行われます。各ウェルは、他のすべてのウェルから独立して非同期に動作します。2つのウェルが同じボリュームを共有している場合、ストレージリザーブに基づいてageoutディレクティブを有効にすると、片方のウェルのデータ量低下に伴い、一方のウェルが積極的に他方に移行したり、データが削除われたりする可能性があります。

注：データが、エイジアウトのマークが付けられているストレージシャードにアクティブに入力されている場合、またはアクティブにクエリされている場合、エイジアウトシステムはシャードのエイジアウトを後で延期します。

## ホット/コールド削除のルール

データがホットウェルからエイジアウトすると、コールドウェルが定義されていればコールドウェルに移動します。コールドウェルが定義されていない場合、`Delete-Cold-Data`オプションで明示的に削除が許可されない限り、データはホットウェルに残されます。

同様に、コールドウェルからデータが古くなった場合（「凍結」）、`Delete-Frozen-Data`パラメータが指定されない限り、データは削除されません。長期的なアーカイブが必要な場合は、凍結したデータを削除する前に[Gravwell archiving service](archive.md)に送ることができます。

これらのルールの例は、以下のセクションの設定スニペットで見ることができる。

警告：ディスクから実際にデータを削除したい場合は、`Delete-Cold-Data` (ホットウェルのみを使用している場合) または`Delete-Frozen-Data` (ホットウェルとコールドウェルの両方を使用している場合)のいずれかを指定する必要があります。これらの設定を行うには、ユーザからの明示的な承認が必要です。適切な削除パラメータをウェル設定に含まない場合、データは削除されず、最終的にはディスクが一杯になってしまいます。

##時間ベースのエイジアウトルール

時間ベースのエイジアウトは、時間保持要件に基づいてデータを管理します。たとえば、組織には、すべてのログを90日間保持するという要件がある場合があります。時間ベースのエージアウト制約は、ポリシーや法的要件によってログの保持時間が決定されるデータプールで最適に使用されます。時間ベースのエイジアウト期間は、大文字と小文字を区別しない次の略語を使用して、日数と週数で指定できます。

* "d"     - 日
* "days"  - 日
* "w"     - 週
* "weeks" - 週

注: シャードは、その*直近*のエントリが期間を超えた場合にのみ、エージアウトされます。

データのホットプールのみを使用し、30日以上前のデータを削除するウェル構成の例：

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Tags=pcap
	Hot-Duration=30D
	Delete-Cold-Data=true
```

データが7日後にホットプールからコールドプールに移動され、90日後にコールドプールから削除される構成の例：

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Cold-Location=/mnt/storage/gravwell_cold/syslog
	Tags=pcap
	Hot-Duration=7D
	Cold-Duration=90D
	Delete-Frozen-Data=true
```

注：上記の構成では、データが97日経過すると、データは完全に削除され、ホットプールで7日間、コールドプールで90日間過ごしました。

時間ベースのエイジアウトは1日に1回呼び出され、エイジアウトできるシャードを各プールでスイープします。デフォルトでは、スイープはUTCの深夜に発生しますが、実行時間は、Ageout-Time-Overrideディレクティブを使用してウェル構成でオーバーライドできます。オーバーライドディレクティブは、24時間UTC時間で指定されます。

UTC午後7時に発生するエイジアウト時間チェックを上書きする設定例：

```
[Storage-Well "syslog"]
	Location=/mnt/xpoint/gravwell/syslog
	Cold-Location=/mnt/storage/gravwell_cold/syslog
	Tags=syslog
	Tags=switchlogs
	Hot-Duration=7D
	Cold-Duration=90D
	Delete-Frozen-Data=true
	Ageout-Time-Override=19:00
```

## 合計ストレージベースのエイジアウトルール

合計ストレージ制約は、期間に関係なく、ボリューム内の特定の量のストレージを割り当てます。ストレージ制約を用いると、Gravwellインデクサーは、サイズが限られている高速ストレージプール（NVMEフラッシュなど）を積極的にフル活用できます。インデクサーは、ウェルが許容量を超えて消費されていない限り、ストレージプール内のエントリを保持します。ストレージ制約により、データストレージに障害をもたらすことなく、予期せぬインジェストのバーストを受けることが可能になります。例えば、インデクサーに1TBの高速フラッシュストレージがあり、通常は7日間のホットストレージを処理していたという場合に、予期しないデータイベントによって1日で600 GBのインジェストが発生した場合、インデクサは、ホット・プールの新しいデータを取り込む能力を妨げることなく、古いデータをコールド・プールにエージングすることができます。 シャードは生成時刻によって優先順位が付けられ、ホットプールとコールドプールの両方で、最も古いシャードが最初にエージアウトされます。

ホットプールに最大500GBのデータを保持し、500GBの制限を超えたときに古いデータを削除するウェル構成の例：

```
[Storage-Well "windows"]
	Location=/mnt/xpoint/gravwell/windows
	Tags=windows
	Tags=sysmon
	Max-Hot-Storage-GB=500
	Delete-Cold-Data=true
```

ホットプールが約50GBを維持し、その後、最大10TBを維持するコールドプールにエイジアウトするウェル構成の例：

```
[Storage-Well "windows"]
	Location=/mnt/xpoint/gravwell/windows
	Cold-Location=/mnt/storage/gravwell_cold/windows
	Tags=windows
	Tags=sysmon
	Max-Hot-Storage-GB=50
	Max-Cold-Storage-GB=10000
	Delete-Frozen-Data=true
```

重要：ストレージベースの制約は、ぎりぎりの厳しい制限をかけるものではありません。ストレージの割り当てを超えた場合に、インデクサーが取り込み中にもデータをエイジアウトできるように、少し余裕を持たせてください。たとえば、ホットストレージデバイスが512GBを保持でき、システムが通常1日あたり100GBを取り込む場合、ストレージ制限を490GBに設定すると、インデクサーがデータを移行している最中にもホットプールが完全に満杯にならないように、十分な余裕を持たせることができます。

## 使用可能なストレージベースのエイジアウトルール

ストレージの可用性に基づいて、ストレージの制約を適用することもできます。一部のウェルは優先度が低く、使用可能な場合にのみストレージを消費する場合があります。storage reservedディレクティブを使用すると、使用可能なストレージの一部がボリューム上で維持されている限り、ウェルが必要なだけのスペースを消費できます。ストレージ可用性ルールは、基本的に、ウェルが「セカンドクラス」ウェルとして機能することを許可し、他に誰もいない場合にのみディスクスペースを消費します。`Hot-Storage-Reserve = 5`を指定すると、ホットストレージボリュームが5％の空き領域を下回った場合に、ウェルが最も古いシャードの移行または削除を開始します。予約ディレクティブは、ストレージの場所をホストしている基になるボリュームに適用されます。つまり、ボリュームが他のウェルまたは他の任意のファイルストレージもホストしている場合、ウェルは必要に応じてストレージの使用量を引き戻すことができます。

ボリュームに30％の空き領域がある限りホットロケーションを使用し、10％の空き領域がある限りコールドボリュームを使用するウェル構成の例：

```
[Storage-Well "doorlogs"]
	Location=/mnt/xpoint/gravwell/doorlogs
	Cold-Location=/mnt/storage/gravwell_cold/doorlogs
	Tags=badgeaccess
	Hot-Storage-Reserve=30
	Cold-Storage-Reserve=10
	Delete-Frozen-Data=true
```

重要：ストレージリザーブで動作するGravwellエイジアウトシステムは、外部の影響に対して完全に直交して動作しています。ウェルが50％のストレージ上限を尊重するように構成され、外部アプリケーションがボリュームを60％まで満たす場合、Gravwellはアクティブな外部のすべてのエントリを削除します シャード。ストレージが予約された状態で構成されたウェルは、消耗品として扱う必要があります。

## 警告と重要な注意事項

エイジアウト制約はシャード全体に適用されるため、単一のシャードがデータ制約のサイズを超えて大きくなった場合、シャードがアイドル状態になるとシャード全体がエイジアウトします。

時間ベースの制約では、シャード全体が指定された時間帯に収まることが必要です。そのため、1日未満の時間の制約には意味がなく、ホットプールは少なくとも2日分のデータを保持できなければなりません。

時間ベースの制約と全体ストレージの制約を組み合わせる場合は注意が必要です。` Hot-Duration=7D` と` Cold-Duration=90D` を指定すると、97日後にデータは削除されます。ただし、`Max-Hot-Storage-GB=2` と `Cold-Duration=90D` を指定すると、ホットウェルが2GBを超えるとホットウェルからコールドウェルにデータが移動し、90日経過するとコールドウェルからデータが削除されます**。

### 透過的な圧縮＋Dockerの注意点

[透過圧縮](compression.md)は、総ストレージを含むエイジアウトルールに重要な意味を持ちます。透過圧縮を有効にしたファイルは、非圧縮版よりもディスク上の容量が少なくなりますが、実際にどのくらいのディスク容量を使っているのかを正確に知ることは困難です。透過圧縮が有効になっている場合、非圧縮データのサイズが5GBに達したときよりも、5GBの*実際のディスク容量*が使用されたときにのみデータをエイジアウトしたいと考えています。

Gravwellは、圧縮が有効になっているBTRFSシステム上のシャードの実際のディスク上のサイズを照会しようとします。一般的なLinuxシステムでは、これは正常に機能します。ただし、** Dockerコンテナを使用する場合**は、特別な注意が必要です。Dockerのランタイムディレクトリ（デフォルトは `/var/lib/docker`）がBTRFSファイルシステム上にある場合、ウェルは透過圧縮を使用できますが、特定のIOCTL呼び出しがデフォルトで無効になっているため、ディスク上のサイズのクエリは失敗します。インデクサーコンテナのインスタンス化に使用するコマンドに`--cap-add=SYS_ADMIN`フラグを渡すことで、Dockerコンテナの適切なIOCTL呼び出しを有効にできます。

### 削除セーフティネット

エイジアウトポリシーによって**データを削除**する可能性があります。管理者は、設定とハードウェアリソースを精査して、ホットストレージプールとコールドストレージプールの両方ともが要求されたエイジアウト制約に対応できることを確認することが非常に重要です。ウェルの設定では、"Delete-X-Data"ディレクティブ（ホットプールの場合は`Delete-Cold-Data`、コールドプールの場合は`Delete-Frozen-Data`）によって削除を明示的に許可する必要があります。

Delete-X-Data ディレクティブは、管理者が設定中にデータの削除を考慮するためのセーフティネットとして使用されます。例えば、ホットプールがあり、コールドプールがなく、ホットリテンションが7日のウェルが設定されている場合、Gravwellはホットプールから7日よりも古いデータを削除しようとします。しかし、井戸に "Delete-Cold-Data=true "の設定指令がない場合、ageoutシステムはデータを削除しません。

コールドプールにも同じ指令要件が含まれており、"Delete-Frozen-Data=true "指令が設定されていない限り、Gravwellはコールドプールからエージングされたデータを削除しないことを意味します。120日前のデータがホットプールに取り込まれ、コールドプールの保持設定が90日で、**Delete-Cold-Dataディレクティブがtrueに設定されている場合**、エイジアウトシステムはコールドプールを完全に迂回してデータを直接削除することに注意してください。

時間ベースのエイジアウトは、データのエイジアウトのタイミングをシステムクロックに依存していますが、システムクロックが不適切な場合、データが早期にエイジアウトされる可能性があります。管理者は、システムクロックが十分に維持されていることを確認し、NTP を使用している場合は信頼できるソースであることを確認する必要があります。攻撃者が妥当な期間Gravwellインデクサーのシステムクロックを制御することができれば、エイジアウトを引き起こす可能性があります。時間はGravwellのアンカーであり、ストレージプールと同じ勢いで保護されなければならなりません。


## エイジアウトルールの相互作用

エイジアウトルールを多段にしたり、組み合わせたりして、ストレージリソースを強固に制御することができます。例えば、ホットプールには小規模な高速ストレージを使用し、コールドプールには低コストの大容量ディスクアレイを使用することを強く推奨しています。 ストレージ制約を組み合わせることで、データ保持ポリシーを守りつつ、小さな高速プールを自由に利用することができます。

データ・エイジアウトの制約は、互いに独立して先着順に動作します。 100GBのストレージ制約に加えて7日の時間制約がウェルに適用された場合、シャードは7日またはプールが100GBを超えたときのいずれか早い方でエイジアウトされます。ウェル内の単一のプールに対して複数の制約を組み合わせるのは便利ですが、過度にアグレッシブなエイジアウト設定をすると予期しない動作を引き起こす可能性があることに注意してください。例えば、ウェルに7日間の保持設定があり、さらにホットストレージリザーバが5%ある場合、Gravwellは7日間の保持とは別に5%の保持を満たそうとします。各ageoutディレクティブは完全に独立して機能し、保持サイズまたはストレージ予約を設定すると、時間ベースのディレクティブをオーバーライドできます。その逆も同様です。

最大100GBのホットストレージを使用し、90日間データを保持するウェル構成の例：

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Max-Hot-Data-GB=100
	Cold-Duration=90D
	Delete-Frozen-Data=true
```

30日間データを保持しながら、ホットストレージボリュームで10％の空き容量を維持しようとするウェル構成の例：

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Hot-Storage-Reserve=10
	Cold-Duration=30D
	Delete-Frozen-Data=true
```

ホットプールに7日または100GBを保持し、20％が使用可能である限りすべてのデータをコールドプールに保持するウェル構成の例：

```
[Storage-Well "weblogs"]
	Location=/mnt/xpoint/gravwell/web
	Cold-Location=/mnt/storage/gravwell_cold/web
	Tags=apache
	Tags=nginx
	Tags=iis
	Hot-Storage-Reserve=100
	Hot-Duration=7D
	Cold-Storage-Reserve=20
	Delete-Frozen-Data=true
```


