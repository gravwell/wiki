# Gravwellクラスター

Gravwellは単一ノードで完全に実行されますが、大量のデータを含む環境はクラスターで最適に処理される場合があります。 Gravwellクラスターでは、1つ以上のWebサーバーが1つ以上のインデクサーを制御し、すべて別々のサーバー上にあります。

Gravwellアーキテクチャの詳細は、[このドキュメント](#!architecture/architecture.md)で説明されています。 この記事では、クラスタリングの構成の詳細をより具体的に扱います。

以下はすべて有効なGravwell構成です。

* 1つのWebサーバーと1つのインデクサー、両方が同じシステムで実行されている。 これがデフォルトのインストールです。 Webサーバーとインデクサーが同じマシン上にあるため、クラスターとは見なしません。
* それぞれ独自のサーバー上の1つのWebサーバーと1つのインデクサー。 これは、可能な限り単純なクラスターです。
* 1つのWebサーバーと複数のインデクサー、それぞれ独自のサーバー上。
*  [複数のWebサーバー](#!distributed/frontend.md)および複数のインデクサー。

単一のWebサーバーと1つ以上のインデクサーを使用してクラスターを構成する方法について説明します。 複数のWebサーバーが必要な場合は、ここで説明する手順に従って最初に単一のWebサーバークラスターを構成し、[このドキュメント](#!distributed/frontend.md)の情報を使用してWebサーバーを後で追加することをお勧めします。また、すべてのウェブサーバーを効果的に利用するためには、[ロードバランシング](loadbalancer.md)の設定も必要になるでしょう。

## クラスターの計画

クラスターを計画する際に留意すべき点がいくつかあります。

* Gravwellライセンス-いくつのノードが許可されていますか？
* 利用可能なサーバーの種類と数
* ネットワーク相互接続
* 取り込みたいデータの量

一定量のデータを保存するために必要なインデクサーの数は、使用可能なハードウェア（ノードあたりのRAMの量、NVME対SSD対回転ディスクなど）とクエリの実行量に大きく依存するため、最後の点は注意が必要です。クラスターの計画については、[Gravwellサポート](mailto:support@gravwell.io) に連絡することをお勧めします。

開始する前に、Webサーバーとインデクサーに使用される特定のIPアドレスまたはホスト名を知っておくと役立ちます。 また、[このドキュメント](#!configuration/networking.md)のポートを確認して、Gravwellコンポーネント間の必要な接続を許可するようにネットワークが構成されていることを確認してください。 簡単に説明すると、Webサーバーがインデクサーのポート9404に到達できること、ユーザーがWebサーバーのポート80および443に到達できること、インジェスターがインデクサーのポート4023および4024に到達できることを確認する必要があります。

**複数のWebサーバーが必要ですか？** ほとんどの場合に、複数のWebサーバーを使用すると、クラスターがより複雑になります。 一般に、単一のWebサーバーをセットアップし、使用中の負荷が高すぎる場合は追加することをお勧めします。

### タグとウェルの計画

ネットフロー、パケットキャプチャ、syslog、Apacheログ、およびWindowsログを取り込むことがわかっている場合は、各データクラスを独自のストレージに適切に配置することを検討する必要があります。 syslogを生パケットなどの大容量のソースとは別のウェルに配置することにより、syslogクエリの速度が向上します。 タグとウェルの詳細については、[高度な構成の記事](#!configuration/configuration.md#Tags_and_Wells)を参照してください。

計画段階では、各データソース、適用するタグ、および保存に使用するタグのリストを作成すると便利です。 取り込むデータがまだわからない場合は、デフォルトのウェル構成を使用して、実際のデータが流入し始めたら調整することができます。

また、この時点で[ageout](#!configuration/ageout.md)のニーズも考慮してください。 システムログをどのくらいの期間保持しますか？ パケットキャプチャ？ Netflowレコード？ たとえば、1日あたり100ギガバイトのパケットを取り込み、クラスターに合計10 TBのストレージがある場合、約100日間の非圧縮パケットデータを保存できますが、それより古いデータはエージングアウトする必要があります。

## Webサーバーのインストール

Webサーバーでインストールを開始することをお勧めします。 これにより、インデクサーを設定するための開始点として使用できる`gravwell.conf`が生成されます。 以下の手順に従って、使用可能な2つの方法のいずれかを使用してWebサーバーをインストールします。

### シェルインストーラーを介したWebサーバーのインストール

[スタンドアロンシェルインストーラー](#!quickstart/downloads.md)を使用してWebサーバーと検索エージェントのみをインストールするには、次のコマンドを実行します（バージョンは異なる場合があります）。

```
root@headnode# bash gravwell_3.2.0.sh --no-indexer
```

### Debianパッケージ経由でWebサーバーをインストールする

DebianパッケージからWebサーバーのみのノードをセットアップするには、いくつかの追加手順が必要です。 [クイックスタート](#!quickstart/quickstart.md#Debian_repository)の説明に従って、リポジトリをセットアップし、Gravwellパッケージをインストールします。 プロンプトが表示されたら、インストーラーが秘密トークンを自動生成できるようにすることができます。

`gravwell`パッケージをインストールした後、インデクサーを無効にする必要があります。

```
root@headnode# systemctl stop gravwell_indexer.service
root@headnode# systemctl disable gravwell_indexer.service
```

## 構成ファイルの構築

Webサーバーがインストールされたので、インデクサーが使用する構成ファイルを作成します。`/opt/gravwell/etc/gravwell.conf` をWebサーバーからローカルディレクトリにコピーし、エディターで開きます。 Webサーバーから`gravwell.conf`ファイルを使用することにより、すべてのインデクサーがまったく同じ認証トークンのセットを共有するようにします。

`Indexer-UUID`で始まる行を削除します。 シェルインストーラーを使用してWebサーバーをインストールした場合、Indexer-UUID行がない可能性があります。 これは結構です。

次に、ストレージウェルを定義します。 執筆時点では、デフォルトの構成により、Linux syslog、Windowsイベントログ、Webサーバーログ（Apache、nginxなど）、netflow/ipfixレコード、およびパケットキャプチャなどの "raw" データ用に個別のウェルが作成されます。 計画したタグ/ウェル設定に一致するように `Storage-Well`定義のいずれかを自由に削除または変更する必要がありますが、設定には**必ず** `Default-Well`定義が含まれている必要があるため、 消して！ ここで、計画段階で選択したガイドラインに従って、各ウェルの[データ保持およびエージアウトポリシー](#!configuration/ageout.md)を定義します。

[データレプリケーション](#!configuration/replication.md)を使用する場合は、インデクサーが相互に保存されたエントリをレプリケートし、ハードウェア障害の場合のデータの損失を防ぎます。 レプリケーションの構成方法については、[レプリケーション記事](#!configuration/replication.md)を参照してください。

## インデクサーのインストール

インデクサー構成ファイルを作成したら、それをインデクサーとして使用するサーバーにコピーする必要があります。 すべてのインデクサーサーバーのファイルを `/tmp/indexer.conf` に配置したと仮定します。

### シェルインストーラーによるインデクサーのインストール

[スタンドアロンシェルインストーラー](#!quickstart/downloads.md)を使用してインデクサーのみをインストールするには、すべてのインデクサーサーバーで次のコマンドを実行します。

```
root@indexer0# bash gravwell_3.2.0.sh  --no-webserver --no-searchagent --use-config /tmp/indexer.conf
```

これにより、構成ファイルが/opt/gravwell/etc/gravwell.confの適切な場所にコピーされるため、必要に応じてインストール後に/tmp/indexer.confを削除できます。

### Debianパッケージを介したインデクサーのインストール

Debianパッケージからインデクサー専用ノードをセットアップするには、いくつかの追加手順が必要です。 すべてのインデクサーサーバーで次の手順を実行します。

[クイックスタート](#!quickstart/quickstart.md#Debian_repository)の説明に従って、リポジトリをセットアップし、Gravwellパッケージをインストールします。 構成ファイルを独自のもので置き換えるため、プロンプトが表示されたときにインストーラーが秘密トークンを自動生成できるようにすることができます。

`gravwell`パッケージをインストールした後、すべてのGravwellサービスを停止します:

```
root@indexer0# systemctl stop gravwell_indexer.service
root@indexer0# systemctl stop gravwell_webserver.service
root@indexer0# systemctl stop gravwell_searchagent.service
```

次に、カスタマイズされた構成ファイルをインストールします。

```
root@indexer0# cp /tmp/indexer.conf /opt/gravwell/etc/gravwell.conf
```

Webサーバーおよび検索エージェントコンポーネントを無効にします。

```
root@indexer0# systemctl disable gravwell_webserver.service
root@indexer0# systemctl disable gravwell_searchagent.service
```

最後に、インデクサーサービスを再起動します。

```
root@indexer0# systemctl start gravwell_indexer.service
```

## 最終的なWebサーバーの構成

この時点で、1つのノードでWebサーバーを実行し、他の複数のノードでインデクサープロセスを実行する必要があります。 最後のステップは、新しく構成されたインデクサーをWebサーバーに通知することです。

Webサーバーに接続し、`/opt/gravwell/etc/gravwell.conf`を編集します。`Remote-Indexers`で始まる行を見つけます。 おそらく`Remote-Indexers=net:127.0.0.1:9404`のようになります。 それを削除してから、*インデクサーごと*に1つのRemote-Indexers行を追加します。 たとえば、インデクサーが10.0.1.1から10.0.1.5にある場合、Webサーバーのgravwell.confには以下が含まれている必要があります。

```
Remote-Indexers=net:10.0.1.1:9404
Remote-Indexers=net:10.0.1.2:9404
Remote-Indexers=net:10.0.1.3:9404
Remote-Indexers=net:10.0.1.4:9404
Remote-Indexers=net:10.0.1.5:9404
```

注：必要に応じて、IPアドレスの代わりにホスト名を使用できます。

ウェブサーバーのgravwell.confが更新されたら、ウェブサーバープロセスを再起動します。

```
root@headnode# systemctl restart gravwell_webserver.service
```

これで、WebブラウザでWebサーバーを指定し、プロンプトが表示されたらライセンスファイルをアップロードできます。 Webサーバーは、ライセンスファイルをインデクサーに自動的に配布します。

## Administration

Gravwellクラスターの管理は、ほとんどの場合、単一ノードのGravwellインスタンスの管理と同じです。 インデクサーが停止している場合、優先度の高い通知がGravwell UIに表示されます。 インデクサーのディスクが過剰にいっぱいになると、通知メッセージを送信します。

## 注意事項

インデクサーがダウンしている場合でも検索を実行できますが、検索の結果にはそのインデクサーに格納されているエントリが不足することに注意してください。 インジェスターが10個のインデクサーに均等にエントリを分散しているが、1つのインデクサーがダウンした場合、検索結果の90％しか含まれないため、統計が不正確になる可能性があります。
