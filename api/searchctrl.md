# サーチコントロール

REST APIは/api/searchctrlにあります。

searchctrlグループは、永続的な検索に関する情報を照会したり、オプションで何らかのアクションを実行するために使用されます。 現在は、すべてのアクティブな検索の問い合わせ、特定の検索に関する情報の取得、アクティブな検索のバックグラウンド、アクティブな検索のアーカイブ、検索の削除/終了などの機能を提供しています。

## 基本的なAPIの概要

ここでの基本的な動作は、REST urlに対してGET, DELETE, PATCHを実行することです。

## 検索の状態

検索は以下のいずれかの状態にあり、同時に複数の状態（ACTIVE/BACKGROUNDED、SAVED/ATTACHED、DORMANT/SAVEDなど）になることができます。

- ACTIVE：検索は実行中および/または終了しており、それに接続されたセッションがあります。
- Backgrounded：検索はアクティブに実行されているが、セッションが接続されていない状態で持続するようにマークされている。
- Saving：検索は保存済みとしてマークされていますが、コンテンツを永続的な場所に移動させるために完了を待っている状態です。
- Saved：検索は保存済みとしてマークされ、適切な永続的な場所に移動されています。
- Dormant：検索は保持（バックグラウンドまたは保存）されており、セッションは添付されていません。
- Attached：検索が保存され、セッションが再接続されています。

## 検索結果の一覧の取得
検索の一覧をリクエストすると、ウェブサーバーは現在のユーザーが閲覧を許可されているすべての検索を返します。 jsonパッケージは投稿されず、'/api/searchctrl'に対して空のGETが実行されます。 

```
[
        {
                "ID": "181382061",
                "UID": 1,
                "GID": 0,
                "State": "ACTIVE",
                "AttachedClients": 1
        },
        {
                "ID": "010985768",
                "UID": 1,
                "GID": 0,
                "State": "BACKGROUNDED",
                "AttachedClients": 0
        },
        {
                "ID": "795927171",
                "UID": 1,
                "GID": 0,
                "State": "DORMANT",
                "AttachedClients": 0
        }
]
```

## 特定の検索の情報を取得する
特定の検索のステータスを取得するには、REST url /api/searchctrl/:ID を GET する必要があります。

```
WEB GET /api/searchctrl/795927171:
[
	{
		"ID": "795927171",
		"UID": 1,
		"UserQuery": "grep paco | grep chico",
		"EffectiveQuery": "grep paco | grep chico | text",
		"StartRange": "2016-12-22T12:41:27.011080417-07:00",
		"EndRange": "2016-12-22T13:01:27.011080417-07:00",
		"Started": "2016-12-22T13:01:27.01227455-07:00",
		"Finished": "0001-01-01T00:00:00Z",
		"StoreSize": 0,
		"IndexSize": 0
	}
]
```

## 検索の背景処理

検索のバックグラウンド化は、最後のクライアントが離脱した場合に、検索を続行しても問題ないことをウェブサーバに知らせるために使用されます。 検索をバックグラウンドにするには、/api/searchctrl/:ID/background correct IDのURLにPATCHを実行します。  このコマンドが成功するためには、検索がアクティブであるか、すでにバックグラウンドになっている必要があり、ユーザーは管理者であるか、検索へのアクセス権を持っている必要があります。

```
WEB PATCH /api/searchctrl/795927171/background:
null
```

## 検索結果の保存

検索の保存は、検索結果を保存しておきたいことをウェブサーバに伝えるために使います。 バックグラウンドで行われた検索は、ウェブサーバがディスクスペースを必要としない（あるいは明示的に削除されない）限り、（誰も接続していなくても）常駐します。 保存すると、検索結果は保存された場所に移動し、（適切な権限を持つ）誰かが明示的に要求しない限り、検索結果が削除されることはありません。 検索結果を保存するには、/api/searchctrl/:ID/save correct ID という URL に対して PATCH を実行します。  検索はどのような状態でもよいのですが、休止状態になって初めて永続的なストレージへの転送が開始されます。 永続的なストレージへの転送は、（永続的なストレージが同じドライブにある場合）瞬時に行われるか、完全なコピーが必要となります。 この処理は、バックグラウンドで独自のゴルーチンで行われるため、処理中にブロックされることはありません。

保存された検索にはオプションでメタデータを添付することができ、メタデータは有効なJSON構造でなければなりません。 メタデータは有効なJSON構造でなければなりません。このメタデータは、メモや情報など、JSONブロブとしてエンコード可能なものなら何でも添付することができます。 メタデータは、検索を保存するための `PATCH` リクエストのボディにエンコードする必要があります。

```
WEB PATCH /api/searchctrl/10985768/save:
null
```

## 検索の削除/終了

検索を削除すると、検索が終了し（アクティブなユーザーがいなくなり）、検索結果に関連付けられたストレージが直ちに削除されます。 検索はどのような状態であっても削除することができます。 検索を削除するには、正しいIDを指定して/api/searchctrl/:IDにDELETEリクエストを送信してください。 サーバーは、成功した場合は200、エラーの場合は5XX、ユーザーが検索の変更を許可されていない場合は403を返します。

```
WEB DELETE /api/searchctrl/010985768:
null
```

## アクティブな検索の停止

検索を停止すると、インデクサは検索パイプラインへの新しいデータの供給を停止しますが、すでに処理された既存のデータは維持され、ユーザーは引き続き出力を操作することができます。保存されている検索や休止状態にある検索は、停止コマンドが発行されるとエラーで応答します。検索を停止するには、正しいIDを指定して/api/searchctrl/ID/stopにPUTリクエストを行います。サーバーは、成功時には200、エラー時には5XX、ユーザーが検索の変更を許可されていない場合には403を返します。 検索の所有者または管理者のみがアクティブな検索を停止することができ、共有グループのユーザーは所有していない検索を停止することはできません。 共有グループのユーザーは、自分が所有していない検索を停止することはできません。停止コマンドが完了した後も、検索結果を保存することができます。

```
WEB PUT /api/searchctrl/010985768/stop:
null
```

## 保存された検索アーカイブのインポート

検索結果のダウンロード形式として、オプションで`archive`があります。 アーカイブは完全に自己完結した検索を表し、別のGravwellインスタンスにインポートすることができます。 インポートAPIは保存された検索アーカイブをアップロードとして受け入れ、検索を保存された検索システムに解凍します。 ユーザーは、あたかもローカルシステムに保存されているかのように、検索に添付することができます。

検索アーカイブが再インポートされると、インポートされた検索は、どのユーザがそれを*ダウンロード*したかに関わらず、*インポート*したユーザによって所有されます。 インポートされた検索をグループで共有するために、オプションの `GID` フォームフィールドをインポート要求で提供することができます。

検索は `/api/searchctrl/import` というURLにマルチパートのフォーム `POST` を実行することでインポートされます。

APIでは，`file`というフォームフィールドにファイルをアップロードすることを想定しています。

インポートAPIは，JWT認証トークンまたはクッキーを使って認証することができます。

注: 管理者は `GID` というフォームフィールドで自分がメンバーではないグループを指定することができますが，管理者以外のユーザは `GID` で指定されたグループのメンバーである必要があります。

## 管理者API

管理者は、上記の API エンドポイントを使用して、検索情報の取得、検索の削除、検索の読み込み、検索のバックグランドへの送信などを行うことができます。

### すべての検索の一覧表示

システム上に存在するすべての検索の一覧を取得するには、管理者ユーザーは `/api/searchctrl/all` を GET します。フォーマットは `/api/searchctrl` から返されるものと同じですが、システム上のすべての検索が含まれています。

```
[
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "486574780",
        "State": "DORMANT",
        "StoredData": 9355,
        "UID": 1
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "815623546",
        "State": "DORMANT",
        "StoredData": 3536,
        "UID": 4
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "525125903",
        "State": "DORMANT",
        "StoredData": 0,
        "UID": 7
    },
    {
        "AttachedClients": 0,
        "GID": 0,
        "ID": "274379984",
        "State": "DORMANT",
        "StoredData": 319,
        "UID": 4
    }
]

```
