# ユーザーファイル API

ユーザーファイルAPIは、キットが（アイコンなどとして使用するための）小さなファイルを保存できるように設計されています。

ユーザーファイルは GUID で参照されます。GUID はシステム全体で必ずしも一意である必要はありません。これにより、例えばダッシュボードで特定のファイルを GUID で参照しているけれども、各ユーザーが自分の好みのファイルをインストールしているというようなことが可能になります。複数のテンプレートまたはピボットが同じ GUID で存在する場合は、 次の順序で優先順位が付けられます。

* ユーザーが所有している
* ユーザーが所属しているグループで共有している
* グローバル

各ファイルは、Gravwellがストレージに使用する固有のUUIDを持っています。以下に説明するadmin APIを使用すると、管理者は「ThingUUID」を参照してユーザーファイルを管理できます。

## ユーザーファイルの作成

ユーザファイルは、`/api/files`へのPOSTリクエストで作成できます。リクエストは以下のフィールドを持つマルチパートリクエストでなければなりません。

* `file`: ファイルの本体
* `name`: ファイル名
* `desc`: ファイルの説明
* `guid`: (オプション) このファイルに対して希望する GUID。設定されていない場合は、1つのGUIDが生成されます。

## ファイルのリストアップ

ユーザーファイルは、`/api/files`をGETすることでリストアップすることができます。結果はファイル情報を含む構造体の配列です。

```
[
	{
		"GUID": "1945c39e-0bd1-40cf-b069-6da64d3f8afe",
		"ThingUUID": "3525901f-5723-11e9-be65-54e1ad7c66cf",
		"UID": 1,
		"GIDs": null,
		"Global": false,
		"Size": 99,
		"Type": "text/plain; charset=utf-8",
		"Name": "blah",
		"Desc": "bar",
		"Labels": ["foo"],
		"Updated": "2019-04-04T15:50:19.290186504-06:00"
	}
]
```

## ファイルの内容の読み込み

ファイルの内容は、`/api/files/<uuid>`のGETリクエストで読み取ることができます。例えば、上のリストにあるファイルを読み取るには、`/api/files/1945c39e-0bd1-40cf-b069-6da64d3f8afe`のようにします。

## ファイルの更新

ファイルの名前、説明、内容は `/api/files/<uuid>` への POST リクエストで変更することができます。リクエストは新しいファイルを作成するためのものと同じで、`file`, `name`, `desc` フィールドに希望の値を設定してください。`guid` フィールドは無視されることに注意してください。

## ファイルのメタデータを更新する

ファイルの様々なフィールド(Name, Desc, Global, GIDs, Labels)は、`/api/files/<uuid>`へのPATCHリクエストで更新することができます。リクエストの本文には、リスト(GET `/api/files`)で返されたのと同じ構造体が含まれていなければなりません。例えば：

```
{
	"UID": 1,
	"GIDs": null,
	"Global": false,
	"Name": "blah",
	"Desc": "bar",
	"Labels": ["foo"],
}
```

上記以外のフィールドが存在していても無視されることに注意してください。

注意：ファイルのUIDを変更できるのは管理者のみで、`?admin=true`パラメータが設定されている場合のみです。

## ファイルの削除

ユーザーファイルは `/api/files/<uuid>` の DELETE で削除することができます。

## 管理者のアクション

管理者ユーザーは、システム上のすべてのユーザーファイルを表示したり、変更したり、削除したりする必要がある場合があります。GUIDは必ずしも一意ではないので、管理者APIは、代わりにGravwellがアイテムを保存するために内部的に使用する一意のUUIDを参照しなければなりません。上記のファイルリストの例には、「ThingUUID」という名前のフィールドが含まれていることに注意してください。これは、そのユーザーファイルの内部的に一意の識別子です。

管理者ユーザーは、`/api/templates?admin=true`のGETリクエストで、システム内のすべてのユーザーファイルのグローバルリストを取得することができます。

その後、管理者は、`/api/files/<ThingUUID>?admin=true`へのDELETEメッセージで特定のファイルを削除し、希望するファイルのThingUUID値を代入することができます。更新にも同じパターンが適用されます。
