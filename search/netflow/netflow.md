## netflow

ネットフロープロセッサは、生のネットフローデータフレームを抽出してフィルタリングするように設計されており、ネットワークフローの迅速な識別、ポートでのフィルタリング、または一般的なアグリゲートフローの動作の監視を可能にします。 Gravwellにはネイティブのネットフロー・インジェスターがあり、オープンソースで、https://github.com/gravwell/ingesters または[quickstart section](#!quickstart/downloads.md)にあるインストーラーとして入手可能です。

### サポートされているオプション

* `-e`: 「-e」オプションは、netflow モジュールが列挙値を操作することを指定します。 列挙型の値を操作することは、上流のモジュールを使って netflow フレームを抽出した場合に有効です。 生の PCAP から netflow フレームを抽出し、そのフレームを netflow モジュールに渡すことができます。

### 処理演算子

netflow の各フィールドは、高速フィルタとして機能する一連の演算子をサポートしています。 各演算子がサポートするフィルタは、フィールドのデータタイプによって決まります。数値はサブセット演算子以外のすべてをサポートし、IP アドレスはサブセット演算子のみをサポートします。

| 演算子 | 名称 | 意味 |
|----------|------|-------------|
| == | 等しい | フィールドは等しい
| != | 等しくない | フィールドは等しくない
| < | 小なり | フィールドはその値より小さい
| > | 大なり | フィールドはその値より大きい
| <= | 小なりイコール | フィールドはその値以下である
| >= | 大なりイコール | フィールドはその値以上である
| ~ | 含まれる | フィールドはそれに含まれる
| !~ | 含まれない | フィールドはそれに含まれない


### データ項目

netflow 検索モジュールは、生の netflow フレームを処理するように設計されています。 1 つの netflow フレームは、ヘッダーと N 個のレコードで構成され、Netflow V5 では、N は 0 以上 31 以下でなければなりません。 netflow レコードの各データ項目は、抽出してフィルタとして使用することができます。 ヘッダーのデータ項目でフィルターをかける場合、フレーム内のすべてのレコードに適用されます。 ヘッダーデータ項目が最初に処理され、ヘッダーフィルターがフレームをドロップしない場合にのみ、レコードが処理されます。 netflow プロセッサは拡張モジュールです。拡張モジュールは、入力エントリを複数の出力エントリに分割します。 つまり、netflow モジュールを使用すると、入力されたエントリよりも多くのエントリがパイプラインから出力される可能性があります。

#### Netflow v5 ヘッダーデータ項目

| フィールド |       意味        | サポートされている演算子 | 例 |
|-------|--------------------------|---------------------|---------|
| Count | netflow フレーム内のレコード数 | > < <= >= == != | Count >= 10
| Version | Netflow フレームのバージョン | > < <= >= == != | Version == 5
| Uptime | netflow センサーがアクティブだった秒数 | > < <= >= == != | Uptime > 0x100000
| Sec|センシングデバイスの現在のUnixタイムスタンプ|> < <= >= == != |Sec == 1526511023
| NSec | 検知デバイスの現在時刻に対する残差ナノ秒 | > < <= >= == != | Nsec > 0x100101
| Sequence | 検知デバイスの総フローのシーケンスカウンタ | > < <= >= == != | Sequence == 1
| EngineType | フロースイッチ・エンジンの種類 | > < <= >= == != | EngineType == 0x1A
| EngineID | フローセンシングエンジンの ID | > < <= >= == != | EngineID == 0x00
| SampleMode | センシングエンジンのサンプリングモードを表す 2 ビットの ID | > < <= >= == != | SampleMode == 0x01
| SampleInterval|センシングエンジンのサンプリング間隔を表す14ビットの値|> < <= >= ==| SampleInterval > 0x100
| Timestamp | Sec と NSec をフレンドリーなタイムスタンプ値に変換するヘルパー抽出器。フィルタリングはサポートされていません。 | |

#### Netflow v5 レコードデータ項目

| フィールド |       意味        | サポートされている演算子 | 例 |
|-------|--------------------------|---------------------|---------|
| IP | フィルターにマッチした最初の IP を抽出します。 フィルターが指定されていない場合は、Src が使用されます。 | ~ !~ == != | IP ~ 10.0.0.0/24
| Port | フィルターにマッチした最初のポートを抽出します。 フィルターが指定されていない場合は、SrcPort が使用されます。 | > < <= >= == != | Port == 80
| Src | フローレコード内のソース IPv4 アドレス | ~ !~ == != | Src !~ 192.168.1.0/24
| Dst | フローレコードの送信先 IPv4 アドレス | ~ !~ == != | Dst ~ 10.0.0.0/16
| Next | フローレコード内の次のホップアドレス | ~ !~ | Next == 1.2.3.4
| Input | 入力インターフェースの SNMP インデックス | > < <= >= == != | Input == 1
| Output | 出力インターフェースの SNMP インデックス | > < <= >= == != | Output != 1
| Pkts | フロー内の総パケット数 | > < <= >= == != | Pkts > 10
| Bytes | フロー内の総バイト数 | > < <= >= == != | Bytes < 1400
| UptimeFirst | 最初のパケットが観測されたときのセンシングエンジンの稼働時間 | > < <= >= == != | UptimeFirst != 0
| UptimeLast | 最後のパケットが確認されたときのセンシングエンジンの稼働時間 | > < <= >= == != | UptimeLast > 0x10000
| SrcPort | フローのソースポート。 プロトコルがポートを持たない場合、値はゼロとなる | > < <= >= == != | SrcPort != 0
| DstPort | フローの宛先ポート。 プロトコルがポートを持たない場合、値はゼロとなる | > < <= >= == != | DstPort == 0
| Flags | フローの TCP フラグの累積 OR | > < <= >= == != | Flags == 0x7
| Protocol | フローのプロトコル番号 (TCP = 6, UDP = 17 | > < <= >= == != | Protocol == 17
| ToS | フローの IP タイプ | > < <= >= == != | ToS == 19
| SrcAs | フローの送信元自律システム番号 | > < <= >= == != | SrcAS == 15169
| DstAs | フローのソース自律システム番号 | > < <= >= == != | DstAs != 15169
| SrcMask | ソース IPv4 アドレスのマスクビット | > < <= >= == != | SrcMask > 24
| DstMask | 送信先 IPv4 アドレスマスクビット | > < <= >= == != | DstMask <= 16
| Duration | UptimeFirst と UptimeLast を期間に変換するヘルパー値 | > < <= >= == != | Duration > 100ms

### 例

#### 送信元 IP 別の HTTP フロー数の推移

```
tag=netflow netflow Src Dst Port==80 | count by Src | chart count by Src limit 24
```

![Number of flows by ip](flowcounts.png)

#### IP およびプロトコル別の総トラフィック

```
tag=netflow netflow IP Protocol Bytes as traffic | sum traffic by IP,Protocol | stackgraph IP Protocol sum
```

![Traffic by protocol per IP](IPProtoTrafficStackgraph.png)
