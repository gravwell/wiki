
## taint

taint モジュールは、taint の解析とフローの追跡に使用されます。 このモジュールは、既知の開始点を指定して、「感染」を前方に伝播させるために使用できます。また、taint は感染の終点を指定し、時間をさかのぼって起点を特定するためにも使用できます。 taint モジュールには、検索システムの方向性を逆転させる機能があります。 例えば、taint が既知のペイシェント・ゼロから開始しようとしている場合、検索は強制的に時間枠の最初から開始され、時間的に前方に移動します。 しかし、taint が既知の感染症から開始し、ペイシェント・ゼロを見つけるために逆算している場合、検索を時間枠の最後から開始し、逆方向に移動させます。

Taintは、汚染された値をソースからデスティネーションまで追跡するために、列挙型の値を必要とします。 taintのsourceおよびdestination引数には、任意の名前の列挙型値を指定できます。 Taintモジュールは、時間を進める際に（患者ゼロから始まる）、source引数で指定された列挙型の値を探し、その値を抽出します。 source値がtaintedとマークされている場合（patient zero引数を介して、または以前にtaintedがあったため）、destination値はtaintedとマークされます。

taint tracking は、-f フラグを使用して、既知の感染ポイントから時間を逆にさかのぼって実行することもできます。ソースとデスティネーションの引数の関係は維持されます（ソースがデスティネーションを感染させる）ので、-f と -pz を使用する場合は、ソースとデスティネーションの列挙値の名前を逆にする必要があります。

Taint Trackingのプロセスは、マークを時間的に前方または後方に伝播させるように設計されています。 例えば、Aが汚染されていることを知っていた場合、AがBに触れ、BがCに触れると、A->B->Cの伝搬が起こり、A、B、Cのいずれもが汚染されているとみなされ、他の列挙された値を汚染する可能性があります。

taint モジュールは、ネットワークフローの伝搬、感染症の伝搬、物理システムの移動などを追跡するために使用できます。 例えば、ICMP の伝播を追跡する場合、ソースの列挙値は "SrcIP"、デスティネーションの引数は列挙値 "DstIP" となります。

Gravwell は、マイアミで開催されたS4x18カンファレンスで、[エアギャップをホップする](https://s4x18.com/sessions/using-force-directed-graphs-to-analyze-huge-event-datasets/) USB ベースの感染者の追跡に成功した研究を発表しました。

注意：taint は検索の方向性を制御できるため、sort モジュールと組み合わせることはお勧めできません。

### 構文

taint モジュールのコマンド構文は、強制有向グラフに似ています。 ソースとデスティネーションを指定し、フローが双方向であるかどうかを指定するフラグを立てなければなりません。 ペイシェント・ゼロ (-pz) や既知の感染症 (-f) など、出発点が必要です。

#### ペイシェント・ゼロからのスタート
```
taint -pz <known value> <src> <dest>
```

#### 既知のエンドポイントからのスタート
```
taint -f <known value> <src> <dest>
```

### サポートされているオプション
* `-pz <arg>`: -pz フラグは、ペイシェント・ゼロ（開始点）の値を指定します。 taint は、\<src\> の列挙値の中から、tainting を開始するためのペイシェント・ゼロの値を探します。
* `-f <arg>`: -f フラグは、既知の感染のための値を指定します。 taint は \<src\> で指定された列挙値の中から、既知の感染した値を探し、taint の追跡を開始します。
* `-b`: -b フラグは感染が双方向であることを指定しており、どちらかの側が過去に汚染されていた場合、その汚染はもう一方の側に移されます。
* `-a`: -a フラグは、すべてのエントリーが taint モジュールを通過するように指定します。つまり、taint モジュールは、taint された値を含まないエントリーを削除しません。

### 例

DNSサーバーのlookupキャッシュにペイロードを埋め込んで任意に感染させることができる、悪質な新しい感染ベクトルが見つかったと仮定した場合、taintモジュールを使って、どのトップレベルドメイン名が攻撃された可能性があるかを特定することができます。 以下の検索は、既知の患者ゼロから始まり、小さなネットワークにおける汚染されたドメインのすべての将来の伝播を示す力の有向グラフを生成します。

```
tag=dns json Remote Answer.Hdr.Name |  regex -e Name "(?P<tld>[^\.]+\.[^\.]+)\.$" | regex -e Remote "(?P<ip>[\d\.]+):\d+" | taint -b -pz 10.0.0.99 ip tld | fdg -b ip tld
```

![DNS Infection Propagation From Known Patient Zero](taintPatientZero.png)

作業の流れを逆にすると、次の検索では、ハンターが既知の感染症から始めて、潜在的なペイシェント・ゼロに向かって逆算する方法を示しています。

```
tag=dns json Remote Answer.Hdr.Name |  regex -e Name "(?P<tld>[^\.]+\.[^\.]+)\.$" | regex -e Remote "(?P<ip>[\d\.]+):\d+" | taint -b -f google.com tld ip | fdg -b ip tld
```

![DNS Infection Propagation From Known End Point](taintBacktrack.png)
