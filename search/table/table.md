# テーブル

テーブルの作成にはテーブルレンダラーを使用します。テーブルの構築は、テーブルレンダラーに引数を提供することで行われます。引数には、列挙値、tag、timestamp、またはsrcを指定する必要があります。引数はテーブルの列として使用されます。

カラム引数を指定しないと、テーブルは列挙されたすべての値を代わりにカラムとして表示します。これは探索に便利です。

## サポートされているオプション

* `-csv`: -saveフラグと組み合わせて、テーブルをネイティブのGravwell形式ではなくCSV形式で保存します（CSVはlookupモジュールとの互換性もあります）。データをエクスポートする場合に便利です。
* `-delete <key>`: `-save`オプションと組み合わせると、指定されたキーに一致するすべてのレコードをリソースから削除します。「key」は、リソース内の列の1つの名前です。リソースから削除するときに、キー付き列の値がテーブル出力の値と一致する場合、リソースの行は削除されます。`-update`と組み合わせることはできません。
* `-format`: `-save`オプションを使用する場合は、宛先リソースの形式を指定します。オプションには、`lookupdata`、` csv`、および `ipexist` が含まれます。
* `-nt`: tableを非一時的なモードにします。これにより、上流の数学モジュールが、テーブルではなく、結果を凝縮するようになります。これにより、時間的なサブセレクションが必要ない場合に、大量のデータに対する検索が非常に速くなります。また、現在、[statsモジュール](#!search/stats/stats.md)を使用する際にも必要とされています。
* `-save <destination>`: 結果のテーブルを[lookupモジュール](#!search/lookup/lookup.md)のリソースとして保存します。これは、ある検索結果を保存して(例えば、DHCPログからMAC->IPマッピングを抽出するなど)、後の検索で使用するのに便利な方法です。
* `-update <key>`: `save` フラグと組み合わせて、既存のテーブルを上書きするのではなく更新します。これは、例えばネットワーク上の全てのMACアドレスのリストを保持するためにスケジュール検索を使用する場合に便利です。既存のlookupテーブルのカラムは、引数として与えられたカラムと一致しなければなりません。古いlookupテーブルと新しいlookupテーブルをマージする際に、古いテーブルの行は、そのキーとなるカラムの値が新しいテーブルに存在しない場合にのみ含まれます。`delete`と組み合わせることはできません。

注意：`-save`オプションを使用する場合、テーブルはデフォルトでGravwellのネイティブパックバイナリ形式で保存されます。CSVを使いたい場合は、`-csv` フラグを指定してください。`-update` フラグは、`-csv`を指定しない限り、バイナリテーブルでCSVリソースを上書きしてしまうことに注意してください。

## サンプルクエリ

### テーブルの基本的な使い方

Netflow レコードからいくつかの要素を抽出し、それらをテーブルに自動的に表示させます：

```
tag=netflow netflow Src Dst SrcPort DstPort | table
```

ブルートフォース SSH 攻撃を見つけます：

```
tag=syslog grep sshd | regex "authentication error for (?P<user>\S+)" | count by user | table user count
```

![](table-render.png)

### -nt オプションの使用

大量のデータがある状況では、テーブルを強制的に非テンポラリモードにして、代わりにcountモジュールが結果を凝縮するようにします：

```
tag=jsonlogs json source | count by source | table -nt source count
```

### -save オプションの使用

DHCPログを使用して、IPからMACへのマッピングを含むルックアップテーブルを構築します：

```
tag=syslog regex "DHCPACK on (?P<ip>\S+) to (?P<mac>\S+)" | unique ip mac | table -save ip2mac ip mac
```

そして、ルックアップテーブルを使ってSSHログインに関連するMACを探します：

```
tag=syslog grep sshd | regex "Accepted .* for (?P<user>\S+) from (?P<ip>\S+)" | lookup -r ip2mac ip ip mac as mac |table user ip mac
```

![](table-ipmac.png)

### -save と -format の使用

`-save` フラグを使う場合、次に述べるように、オプションで保存先のリソースのフォーマットを指定することができます。

- `lookupdata`: デフォルトのリソースフォーマットです。JSONにエンコードされたフォーマットで、カラム名と行のエントリが含まれています。`lookup`モジュールと互換性があります。
- `csv`: シンプルなCSVリソースフォーマットです。
- `ipexist`: lookupのパフォーマンスを最適化する `ipexist` モジュール用のカスタムバイナリフォーマットです。

### -update オプションの使用

この例では、ローカルネットワーク上で見られるIPアドレスを含むテーブルを構築し、それをさらに更新します。

まず、192.168.2.0/24 ネットワーク上で見られるすべてのユニークなプライベートIPv4アドレスを含むテーブルを構築します：

```
tag=pcap packet ipv4.SrcIP ~ PRIVATE | unique SrcIP | subnet SrcIP /24 | eval subnet == toIP("192.168.2.0") | table -save test -csv SrcIP
```

![](update1.png)

結果のリソース (名前は 'test') をダウンロードすると、期待されるテーブルが表示されます：

```
SrcIP
192.168.2.1
192.168.2.52
192.168.2.60
192.168.2.51
192.168.2.61
```

次に、192.168.0.0/24 サブネットで見られるIPを追加するために別の検索を実行します：

```
tag=pcap packet ipv4.SrcIP ~ PRIVATE | unique SrcIP | subnet SrcIP /24 | eval subnet == toIP("192.168.0.0") | table -update SrcIP -save test -csv SrcIP
```

![](update2.png)

表示されるテーブルには新しいIPアドレスのみが表示されますが、リソースには両方の検索結果が含まれるようになりました：

```
SrcIP
192.168.0.50
192.168.0.60
192.168.0.1
192.168.0.71
192.168.0.30
192.168.0.2
192.168.0.73
192.168.0.70
192.168.0.42
192.168.0.72
192.168.2.1
192.168.2.52
192.168.2.60
192.168.2.51
192.168.2.61
```

-update には 'SrcIP' を引数として渡しています。これは重複排除のために使われます。古いテーブルの行で SrcIP が新しいテーブルの行と一致するものは、更新されたリソースには含まれません。
