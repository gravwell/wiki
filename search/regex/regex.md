## regex

regex は、正規表現を使ってテキストデータを照合するパイプラインモジュールです。複雑なパターンを照合したり、テキストから列挙可能なフィールドを抽出したりする非常に強力な方法です。正規表現に慣れていない方は、[Wikipedia の記事](https://ja.wikipedia.org/wiki/%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%8F%BE)が適切な出発点となるでしょう。

正規表現を構築することはこのドキュメントの範囲外ですが、一つ重要なことは、`(?P<foo> .*)` スタイルの構文で、マッチしたグループを列挙型フィールド（この例では「foo」という名前）に割り当てることです。これらの列挙型フィールドは、分析やチャート作成などを行う際に便利です。

例えば、以下の検索は、sshd Accepted ログエントリからメソッド、ユーザー、および ip を列挙します。

```
".*sshd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)"
```

正規表現は非常に長くなる可能性があるため、regex モジュールは、正規表現を含むリソースを指定する `-r` フラグを受け取ります。リソースを入力するときには、検索に直接入力するときのように、式全体を「折り返し引用符」で囲んではいけません。例えば、`".*ssh.*Accepted"` は `.*ssh.*Accepted` となります。これは、通常、検索パーサーが正規表現モジュールに渡す前に、引用符を取り除いているためです。

### サポートされているオプション

* `-e <arg>`: 「-e」オプションは、レコード全体ではなく、列挙値に対して動作します。例えば、80 番ポートに向かっていないけれども、HTTPテキストを持つパケットを表示するパイプラインは、`tag=pcap packet ipv4.DstPort!=80 tcp.Payload | regex -e Payload ".*GET \/ HTTP\/1.1.*"` となります。
* `-r <arg>`: 「-r」オプションは、正規表現文をリソースファイルに配置することを指定します。
* `-v`: 「-v」オプションは、regex の動作を逆にして、regex にマッチするエントリーをドロップし、マッチしないエントリーをパスするようにします。
* `-p`: 「-p」オプションは、正規表現がまったくマッチしない場合でも、エントリーを通過させるよう regex に指示します。permissive フラグは、フィルターの動作を変更しません。

注意：特に大きな正規表現をリソースファイルに格納することで、クエリをすっきりさせることができ、また再利用も容易になります。 `-r` が指定された場合は、クエリに正規表現を指定せず、リソースの内容を使用します。便利ですね。

### インラインフィルタリング

regexモジュールは、インラインフィルタリングをサポートしており、regexモジュール内で直接データをダウンセレクションすることができます。 インラインフィルタリングにより、regexはアクセラレータを使用して処理が必要なデータ量を大幅に削減することができます。 インラインフィルタリングは、他のモジュールと同様に比較演算子を使用して実現されます。 等値性（「等しい」、「等しくない」、「含まれる」、「含まれない」）を指定するフィルタが有効な場合、フィルタの指定に失敗したエントリは完全に削除されます。 Not equal "!=" と指定されたフィールドが存在しない場合、そのフィールドは抽出されませんが、エントリが完全に削除されることはありません。


| 演算子 | 名称 | 意味 |
|----------|------|-------------|
| == | 等しい | フィールドは等しい
| != | 等しくない | フィールドは等しくない
| ~ | 含む | フィールドはその値を含む
| !~ | 含まない | フィールドはその値を含まない

#### フィルタリングの例

```
tag=syslog regex "shd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)" user==root ip ~ "192.168"
```

### パラメータ構造
```
regex <argument list> <regular expression> <filter arguments>
```
### 検索例
```
tag=syslog grep sshd | regex *shd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)"
```
