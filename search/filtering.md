# インラインフィルタリング

例えば、Netflowデータから全てのHTTPSフローを削除したい、特定のサブネットから発信されたトラフィックだけを調べたい、Windowsログの特定のユーザ名に一致させたいなど、何らかの基準に基づいてクエリのエントリをフィルタリングしたい場合がよくあります。*インラインフィルタリング*は、さまざまな種類のGravwellデータをフィルタリングするための効率的な方法です。

Gravwellの抽出モジュールは、通常、抽出時に*抽出*された項目を*フィルタリング*することができます。以下のクエリでは、パケットからIPv4の宛先IPとTCPの宛先ポートを抽出しています:

```
tag=pcap packet ipv4.DstIP tcp.DstPort
```

例えば、10.0.0.0.0/8サブネット内のIPのポート22向けのパケットのみを表示するようにフィルタを追加することができます:

```
tag=pcap packet ipv4.DstIP ~ 10.0.0.0/8 tcp.DstPort == 22
```

DstIPとDstPortが指定されたフィルタと一致しないエントリは、**削除**されます。

## フィルタリング演算子とデータタイプ

検索パイプラインの中では、列挙値は、文字列、整数、IPアドレスなど、様々な異なる*タイプ*になる可能性があります。あるIPアドレスが他のIPアドレス"未満"かどうかを尋ねるのは特に有用ではありません!特定の方法ではフィルタリングできないタイプもあります。Gravwellがサポートするフィルタリング演算子は以下の通りです:

| 演算子 | 名前 |
|----------|------|
| == | 等しい |
| != | 等しくない |
| < | 未満 |
| > | より大きい |
| <= | 以下 |
| >= | 以上 |
| ~ | 含む |
| !~ | 含まない |

これらの操作のほとんどは説明不要ですが、"含む(~)"演算子については言及する必要があります。文字列の場合は「列挙値に引数が含まれている」ことを意味し、IPアドレスの場合は「IPアドレスが指定されたサブネット内にある」ことを意味します。したがって、`json domainName ~ "gravwell.io"`は、"domainName"という名前のJSONフィールドに"gravwell.io"という文字列が含まれているエントリだけを通過させることができます。同様に、`packet ipv4.DstIP ~ 10.0.0.0/8`とすると、IPv4の宛先IPアドレスが10.0.0.0/8サブネットに含まれるエントリのみを通過させることができます。

各列挙値は、一部のフィルターと互換性がありますが、他のフィルターとは互換性がありません:

| 列挙値タイプ | 互換性のある演算子 |
|-------------|-------------------|
| string | ==, !=, ~, !~
| byte slice | ==, !=, ~, !~
| MAC address | ==, !=
| IP address | ==, !=, ~, !~
| integer | ==, !=, <, >, <=, >=
| floating point | ==, !=, <, >, <=, >=
| boolean | ==, !=
| duration | ==, !=, <, >, <=, >=

## フィルタリングと加速

データが[アクセラレーションウェル](#!configuration/accelerators.md)にある場合、インラインフィルターを使用してクエリを高速化することができます。等号演算子(==)のみがアクセラレーションを行います。等式のフィルタリングを行うことで、アクセラレーション・エンジンは目的のフィールドに一致するエントリを検索します。

アクセラレーションを行うには、指定したフィールドでアクセラレーションを行うようにデータを構成する必要があります。例えば、 pcap データを tcp.DstPort と tcp.SrcPort のフィールドでインデックス化している場合、 `tag=pcap packet tcp.DstPort==22` というクエリはインデックスを使用しますが、 `tag=pcap packet ipv4.SrcIP==10.0.0.1` は使用しません。

## ビルトインキーワード

SolitonNKはフィルタリングのためにいくつかの特別なショートカットを実装しています。IPアドレスをサブネットでフィルタリングする場合、単一のサブネットを指定する代わりに、PRIVATEとMULTICASTというキーワードを指定することができます(例: `packet ipv4.DstIP ~ PRIVATE`)。キーワードは以下のサブネットにマッピングされます:

* PRIVATE: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, 224.0.0.0/24, 169.254.0.0/16, fd00::/8, fe80::/10
* MULTICAST: 224.0.0.0/4, ff00::/8

## フィルタリングの例

Regex:

```
tag=syslog regex *shd.*Accepted (?P<method>\S*) for (?P<user>\S*) from (?P<ip>[0-9]+.[0-9]+.[0-9]+.[0-9]+)" user==root ip ~ "192.168"
```

AX:

```
tag=testregex,testcsv ax dstport==80 | table app src dst
```

CSV:

```
tag=default csv [5]!=stuff [4] [3]~"things" | table 3 4 5
```

IPFIX:

```
tag=ipfix ipfix destinationIPv4Address as Dst destinationTransportPort==443 | count by Dst | chart count by Dst
```

IP module:

```
tag=csv csv [2] as srcip | ip srcip ~ PRIVATE
```
