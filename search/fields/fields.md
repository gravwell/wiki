## Fields

fieldsモジュールは、後で使用するために、検索エントリから列挙値にデータを抽出してフィルタ処理するために使用されます。fieldsモジュールは、データ項目が一定のバイトセットで区切られている場合に、データをキャプチャしてフィルタ処理する際に非常に柔軟になるように設計されています。カンマ区切り(CSV)、タブ区切り、スペース区切りの形式は、fieldsモジュールを使用して簡単に処理できます。マルチバイトの区切り文字や既知のフィールド区切り文字を持つバイナリフォーマット、あるいはその両方を使用したもっと複雑な構造では、フィールドシステムを使用して任意のフィールド境界で抽出できます。fieldsモジュールの恩恵を受けることができるデータプロデューサーの例は、タブ区切り形式またはsnortからのCSV出力形式を持つ[bro](https://www.bro.org/)です。

数値フィールドオフセットの指定は頻繁に使用すると面倒になることがあるため、namedfieldsモジュールはユーザーがアップロードしたリソースを使用してフィールドインデックスにわかりやすい名前を割り当てます。

### 抽出フィールドの設定

フィールドは、ゼロの基数からデータへのインデックスを指定することによって抽出されます。インデックスは、角括弧で囲まれた正の整数を使用して指定されます。複数のディレクティブを指定することで複数のフィールドを抽出できます。フィールド抽出インデックスを順番に指定する必要はありません。


抽出されたインデックスフィールドは、フィールドのインデックス値の直後に `as <name>` というディレクティブを追加することで、名前を変更することができます。 例えば、あるデータの第6フィールドを "uri"という名前の列挙値に抽出する場合、抽出ディレクティブは `[5] as uri` となります。 名前変更ディレクティブが提供されていない場合、抽出された値にはインデックスに一致する名前が与えられます。抽出されたフィールドはフィルタもサポートしており、同等性や含まれる値に基づいてエントリを素早くフィルタリングすることができます。フィルタは名前変更の前に指定する必要があります。例えば、第1フィールドが "stuff"という値のエントリーのみを通過させるフィールドディレクティブの例は、`[0]=="stuff"`です。第1フィールドが値 "stuff"と等しくないエントリーのみを許可し、第1フィールドを "things"にリネームする場合は、`[0] != "stuff" as things`となります。


重要: フィールド抽出インデックスは、ベース10、ベース8、またはベース16で指定できます。デフォルトで適用される名前は、インデックスの元のテキスト値です。[0xA]という抽出指示は、11番目のフィールドを抽出して "0xA" という名前をつけ、[010]という抽出指示は、9番目のフィールドを抽出して "010" という名前をつけます。

重要: フィルタ値や抽出名に"-"、"."、スペースなどの特殊文字を含む場合は、二重引用符で囲んで指定します。

### サポートされているオプション

* `-e <arg>`: "-e"オプションは、レコード全体ではなく、列挙値に対して操作を行います。
* `-d <arg>` : "-d"オプションは、フィールドを抽出する際のデリミタを指定する。 区切り文字には、任意のバイト列を指定できます。 デフォルトではカンマ","が指定されます。
* `-s` : "-s"オプションは、fieldsモジュールが厳密モードで動作することを指定します。 フィールドの仕様が満たされない場合、そのエントリーは削除されます。 例えば、0番目、1番目、2番目のフィールドが必要なのに、エントリーには2つのフィールドしかない場合、strictフラグを指定すると、エントリーが削除されます。
* `-q` : "-q"オプションは、フィールドを引用符で囲むことを指定します。 これは、フィールドに表示される可能性のあるデリミタを扱う際に便利です。 例えば、フィールドのデリミタがスペースの場合、カラムにはスペースを含める必要があるため、引用符で囲まれます。 "-q"引数が指定された場合、二重引用符で囲まれたデリミタは無視され、フィールドに含まれます。 "-q"フラグを使用する場合、デリミタに二重引用符を含めることはできません。
* `-clean` : "-clean"フラグは、fieldsモジュールが抽出されたフィールドから周囲のホワイトスペースをすべて削除することを指定します。 CSVのように末尾にホワイトスペースがあるデータ形式では、"-clean"フラグを使用して不要なホワイトスペースを削除できます。 "-q"フラグを"-clean"と一緒に指定すると、引用符で囲まれたフィールドから二重引用符が削除されます。

### フィルタリング演算子

fieldsモジュールでは、同等性に基づくフィルタリングが可能です。 同等性を指定したフィルタ（"等しい","等しくない","含む","含まない"）が有効な場合、フィルタの指定に失敗したエントリは完全に削除されます。フィールドが等しくない: "！="として指定され、フィールドが存在しない場合、そのフィールドは抽出されませんが、エントリーが完全に削除されることはありません。

| 演算子 | 名前 | 説明 |
|----------|------|-------------|
| == | 等しい | フィールドは等しい
| != | 等しくない | フィールドは等しくない
| ~ | 含む | フィールドはその値を含む
| !~ | 含まない | フィールドはその値を含まない

### 例

タブ区切りのbro http.logフィードからURLフィールドを抽出し、"url"という名前を付けます。

```
tag=brohttp fields -d "\t" [9] as url
```

タブ区切りの bro http.log フィードから URL と requester フィールドを抽出し、URL にスペースが含まれるエントリのみをフィルタリングして、結果をテーブルに出力することができます。

```
tag=brohttp fields -d "\t" [9] ~ " " as url [2] as requester | table url requester
```

第4、第5、第6フィールドを"|"のデリミタを使って抽出し、抽出されたフィールドからホワイトスペースを取り除きます。

```
tag=default fields -clean -d "|" [3] [4] [5] | table 3 4 5
```

bro httpのログストリームからURIを抽出し、そのURIをパスとPUT引数コンポーネントに分離し、各パスの引数のエントロピーを計算し、結果をグラフ化します。

```
tag=brohttp fields -d "\t" [9] ~ "?" as uri |  regex -e uri "^(?P<path>[^\?;]+)\?(?P<args>.+)" | entropy args by path | chart entropy by path
```

複数のストリームを持つJPEG構造のHTTPパケットを検出します。（例：メイン画像とサムネイルなど）

```
tag=pcap packet tcp.Port==80 tcp.Payload | fields -s -e Payload -d "\xd8\xff" [1]~"JFIF"  [2]~"JFIF" | slice 1[0:10] 2[0:10] | table 1, 2
```
